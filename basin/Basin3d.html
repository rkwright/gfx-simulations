<!DOCTYPE html>
<html>
	<head>
		<!--
  			@author: rkwright@geofx.com
		-->
		<title>Basin 3D</title>
		<meta http-equiv="content-type" content="text/html; charset=UTF-8"/>

		<!-- Set the viewport size to the screen size, so it will be displayed maximized, but unscaled. -->
		<meta name="viewport" content="width=device-width, height=device-height, initial-scale=1"/>

		<!-- Include several libraries from THREE.js and the Scene class  -->
		<script src="../three-js/three.js" type="text/javascript"></script>
		<script src="../three-js/Detector.js" type="text/javascript"></script>
		<script src="../three-js/OrbitControls-Touch-Ortho.js" type="text/javascript"></script>
		<script src="../three-js/stats.js" type="text/javascript"></script>
        <script src="../gfx/gfx-scene.js" type="text/javascript"></script>
        <script src="../maze/Maze.js"></script>
        <script src="../maze/MazeRat.js"></script>
        <script src="Basin.js"></script>
	</head>
	<body style="margin:0;padding:0;border:0">
    <script type="text/javascript">
        var NCELLS = 4;
        var plane;
        var terrain = [];
        var planeMesh;

        var gfxScene = new GFX.Scene( {
            cameraPos : [10, 20, 20],
            axesHeight:10,
            controls:true,
            displayStats:true
        });


        initializeDemo();

        animateScene();

        /**
         * Initialize the Demo.
         */
        function initializeDemo() {
            var basin;
            var startTime = performance.now();

            basin = new BASIN.Basin(NCELLS);

            basin.construct();

            createTerrain( NCELLS );

            createPlaneGeometry( NCELLS );

            createPlaneMesh();

            var elapsed = (performance.now() - startTime)/1000.0;
            console.log("Basin complete! elapsed: " +  elapsed.toFixed(3)  );
        }

        /**
         * This creates the terrain array but sets elevation to -1 to indicate that
         * it is uninitialized.
         */
        function createTerrain( nCells ) {

            // first, create and populate the terrain array
            for ( var i = 0; i < nCells*2+1; i++ ) {
                terrain[i] = [];
                for ( var j = 0; j < nCells*2+1; j++ ) {
                    terrain[i][j] = new THREE.Vector3(j, -1, i);
                }
            }
        }

        /*
         * This creates the mesh comprised of nCells by nCells quad-patches.
         * Elevations are still all -1
         */
        function createPlaneGeometry( nCells ) {

            plane = new THREE.Geometry();

            for ( var i = 0; i < nCells*2; i += 2 ) {
                for ( var j = 0; j < nCells*2; j += 2 ) {
                    createQuadPatch( i, j );
                }
            }
        }

        function createPlaneMesh()  {

            var wireMat = new THREE.MeshBasicMaterial({
                color: 0xccccff,
                wireframe: true, transparent: true, opacity: 0.1
            });
            var colorMat = new THREE.MeshPhongMaterial({
                color: 0x598527,
                side: THREE.DoubleSide
            });

            planeMesh = THREE.SceneUtils.createMultiMaterialObject(plane, [colorMat, wireMat]);

            // and add it to the scene
            gfxScene.add(planeMesh);
            planeMesh.position.set(-NCELLS, 0, -NCELLS)

        }

        function createQuadPatch( i, j ) {
            var vC = plane.vertices.length;

            // first pair of triangles
            plane.vertices.push( terrain[i][j] );
            plane.vertices.push( terrain[i][j+1] );
            plane.vertices.push( terrain[i+1][j+1] );
            plane.vertices.push( terrain[i+1][j] );

            plane.faces.push(new THREE.Face3(vC + 0, vC + 1, vC + 2));
            plane.faces.push(new THREE.Face3(vC + 0, vC + 2, vC + 3));

            // second pair of triangles
            vC = plane.vertices.length;
            plane.vertices.push( terrain[i][j+1] );
            plane.vertices.push( terrain[i][j+2] );
            plane.vertices.push( terrain[i+1][j+2] );
            plane.vertices.push( terrain[i+1][j+1] );

            plane.faces.push(new THREE.Face3(vC + 0, vC + 1, vC + 3));
            plane.faces.push(new THREE.Face3(vC + 1, vC + 2, vC + 3));

            // third pair of triangles
            vC = plane.vertices.length;
            plane.vertices.push( terrain[i+1][j+1] );
            plane.vertices.push( terrain[i+1][j+2] );
            plane.vertices.push( terrain[i+2][j+2] );
            plane.vertices.push( terrain[i+2][j+1] );

            plane.faces.push(new THREE.Face3(vC + 0, vC + 1, vC + 2));
            plane.faces.push(new THREE.Face3(vC + 0, vC + 2, vC + 3));

            // fourth pair of triangles
            vC = plane.vertices.length;
            plane.vertices.push( terrain[i+1][j] );
            plane.vertices.push( terrain[i+1][j+1] );
            plane.vertices.push( terrain[i+2][j+1] );
            plane.vertices.push( terrain[i+2][j] );

            plane.faces.push(new THREE.Face3(vC + 0, vC + 1, vC + 3));
            plane.faces.push(new THREE.Face3(vC + 1, vC + 2, vC + 3));
        }

        /**
         * Animate the scene and call rendering.
         */
        function animateScene() {

            requestAnimationFrame(animateScene);

            gfxScene.renderScene();
        }

    </script>

	</body>
</html>
